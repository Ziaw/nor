using Nemerle.Collections;
using Nemerle.Text;
using Nemerle.Utility;

using System;
using System.Collections.Generic;
using System.Linq;
using NUnit.Framework;
using NRails;
using NRails.Database;
using NRails.Database.Schema;
using NRails.Migrations;
using NRails.Macros.Migration;

namespace NRails.Tests
{
  /// <summary>
  /// Description of MigrationTests.
  /// </summary>
  class MigrationTests: AssertionHelper
  {
      class CreateMigrationTest : MigrationBase
      {
          public Up() : void
          {
              create Test
              {
                  Id : string;
              };
              CreateTable("Test2", _ => {});
          }
      }

      [Test]
      public CreateTableTest() : void
      {
          CreateTableTest.[CreateMigrationTest]();
      }
      
      protected CreateTableTest[T]() : void where T : MigrationBase
      {
          def schema = DBSchema();
          def migr = CreateMigrationTest();
          
          def migrService = migr : IMigration;
          migrService.AssignSchema(schema);
          
          migr.Up();
          
          def actions = migrService.GetActions();
          
          match (actions)
          {
            | MigrationAction.CreateTable(t, [TableAction.AddColumn]) :: MigrationAction.CreateTable(t2, []) :: [] => 
                Expect(t.Name, Is.EqualTo("Test"));
                Expect(t2.Name, Is.EqualTo("Test2"));
            | _ => Assert.Fail();
          }
      }
  }
}
